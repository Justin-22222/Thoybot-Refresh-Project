{"version":3,"sources":["../../src/core/robo.ts"],"names":["color","registerProcessEvents","Compiler","Client","Collection","Events","getConfig","loadConfig","FLASHCORE_KEYS","discordLogger","logger","env","executeAutocompleteHandler","executeCommandHandler","executeContextHandler","executeEventHandler","hasProperties","PackageDir","Flashcore","prepareFlashcore","loadState","Portal","path","isMainThread","parentPort","Robo","restart","start","stop","client","portal","plugins","options","optionsClient","shard","stateLoad","config","ShardingManager","shardPath","manager","result","stateStart","state","loadPluginData","key","onlyAuto","event","args","interaction","commandKey","getCommandKey","exitCode","commandKeys","collection","plugin","name","metaOptions"],"mappings":"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","sourcesContent":["import { color } from './color.js'\nimport { registerProcessEvents } from './process.js'\nimport { Compiler } from './../cli/utils/compiler.js'\nimport { Client, Collection, Events } from 'discord.js'\nimport { getConfig, loadConfig } from './config.js'\nimport { FLASHCORE_KEYS, discordLogger } from './constants.js'\nimport { logger } from './logger.js'\nimport { env } from './env.js'\nimport {\n\texecuteAutocompleteHandler,\n\texecuteCommandHandler,\n\texecuteContextHandler,\n\texecuteEventHandler\n} from './handlers.js'\nimport { hasProperties, PackageDir } from '../cli/utils/utils.js'\nimport { Flashcore, prepareFlashcore } from './flashcore.js'\nimport { loadState } from './state.js'\nimport Portal from './portal.js'\nimport path from 'node:path'\nimport { isMainThread, parentPort } from 'node:worker_threads'\nimport type { HandlerRecord, PluginData } from '../types/index.js'\nimport type { AutocompleteInteraction, CommandInteraction } from 'discord.js'\n\nexport const Robo = { restart, start, stop }\n\n// Each Robo instance has its own client, exported for convenience\nexport let client: Client\n\n// A Portal is exported with each Robo to allow for dynamic controls\nexport const portal = new Portal()\n\n// Be careful, plugins may contain sensitive data in their config\nlet plugins: Collection<string, PluginData>\n\ninterface StartOptions {\n\tclient?: Client\n\tshard?: string | boolean\n\tstateLoad?: Promise<void>\n}\n\nasync function start(options?: StartOptions) {\n\tconst { client: optionsClient, shard, stateLoad } = options ?? {}\n\n\t// Important! Register process events before doing anything else\n\t// This ensures the \"ready\" signal is sent to the parent process\n\tregisterProcessEvents()\n\n\t// Load config and manifest up next!\n\t// This makes them available globally via getConfig() and getManifest()\n\tconst [config] = await Promise.all([loadConfig(), Compiler.useManifest()])\n\tlogger({\n\t\tdrain: config?.logger?.drain,\n\t\tenabled: config?.logger?.enabled,\n\t\tlevel: config?.logger?.level\n\t}).debug('Starting Robo...')\n\n\t// Wanna shard? Delegate to the shard manager and await recursive call\n\tif (shard && config.experimental?.disableBot !== true) {\n\t\tdiscordLogger.debug('Sharding is enabled. Delegating start to shard manager...')\n\t\tconst { ShardingManager } = await import('discord.js')\n\t\tconst shardPath = typeof shard === 'string' ? shard : path.join(PackageDir, 'dist', 'cli', 'shard.js')\n\t\tconst options = typeof config.experimental?.shard === 'object' ? config.experimental.shard : {}\n\t\tconst manager = new ShardingManager(shardPath, { ...options, token: env('discord.token') })\n\n\t\tmanager.on('shardCreate', (shard) => discordLogger.debug(`Launched shard`, shard.id))\n\t\tconst result = await manager.spawn()\n\t\tdiscordLogger.debug('Spawned', result.size, 'shard(s)')\n\t\treturn\n\t}\n\n\t// Get ready for persistent data requests\n\tawait prepareFlashcore()\n\n\t// Wait for states to be loaded\n\tif (stateLoad) {\n\t\t// Await external state promise if provided\n\t\tlogger.debug('Waiting for state...')\n\t\tawait stateLoad\n\t} else {\n\t\t// Load state directly otherwise\n\t\tconst stateStart = Date.now()\n\t\tconst state = await Flashcore.get<Record<string, unknown>>(FLASHCORE_KEYS.state)\n\n\t\tif (state) {\n\t\t\tloadState(state)\n\t\t}\n\t\tlogger.debug(`State loaded in ${Date.now() - stateStart}ms`)\n\t}\n\n\t// Load plugin options\n\tconst plugins = loadPluginData()\n\n\t// Create the new client instance (unless disabled)\n\tif (config.experimental?.disableBot !== true) {\n\t\tclient = optionsClient ?? new Client(config.clientOptions)\n\t} else {\n\t\tlogger.debug(`Bot is disabled, skipping client setup...`)\n\t}\n\n\t// Load the portal (commands, context, events)\n\tawait Portal.open()\n\n\t// Notify lifecycle event handlers\n\tawait executeEventHandler(plugins, '_start', client)\n\n\tif (config.experimental?.disableBot !== true) {\n\t\t// Define event handlers\n\t\tfor (const key of portal.events.keys()) {\n\t\t\tconst onlyAuto = portal.events.get(key).every((event: HandlerRecord<Event>) => event.auto)\n\t\t\tclient.on(key, async (...args) => {\n\t\t\t\tif (!onlyAuto) {\n\t\t\t\t\tdiscordLogger.event(`Event received: ${color.bold(key)}`)\n\t\t\t\t}\n\t\t\t\tdiscordLogger.trace('Event args:', args)\n\n\t\t\t\t// Notify event handler\n\t\t\t\texecuteEventHandler(plugins, key, ...args)\n\t\t\t})\n\t\t}\n\n\t\t// Forward command interactions to our fancy handlers\n\t\tclient.on(Events.InteractionCreate, async (interaction) => {\n\t\t\tif (interaction.isChatInputCommand()) {\n\t\t\t\tconst commandKey = getCommandKey(interaction)\n\t\t\t\tdiscordLogger.event(`Received slash command interaction: ${color.bold('/' + commandKey)}`)\n\t\t\t\tdiscordLogger.trace('Slash command interaction:', interaction.toJSON())\n\t\t\t\tawait executeCommandHandler(interaction, commandKey)\n\t\t\t} else if (interaction.isAutocomplete()) {\n\t\t\t\tconst commandKey = getCommandKey(interaction)\n\t\t\t\tdiscordLogger.event(`Received autocomplete interaction for: ${color.bold(interaction.commandName)}`)\n\t\t\t\tdiscordLogger.trace('Autocomplete interaction:', interaction.toJSON())\n\t\t\t\tawait executeAutocompleteHandler(interaction, commandKey)\n\t\t\t} else if (interaction.isContextMenuCommand()) {\n\t\t\t\tdiscordLogger.event(`Received context menu interaction: ${color.bold(interaction.commandName)}`)\n\t\t\t\tdiscordLogger.trace('Context menu interaction:', interaction.toJSON())\n\t\t\t\tawait executeContextHandler(interaction, interaction.commandName)\n\t\t\t}\n\t\t})\n\n\t\t// Log in to Discord with your client's token\n\t\tawait client.login(env('discord.token'))\n\t}\n}\n\nasync function stop(exitCode = 0) {\n\ttry {\n\t\t// Notify lifecycle handler\n\t\tawait executeEventHandler(plugins, '_stop', client)\n\t\tclient?.destroy()\n\t\tlogger.debug(`Stopped Robo at ` + new Date().toLocaleString())\n\t} finally {\n\t\tif (isMainThread) {\n\t\t\tprocess.exit(exitCode)\n\t\t} else {\n\t\t\tawait logger.flush()\n\t\t\tparentPort?.postMessage({ event: 'stop', payload: 'exit' })\n\t\t\tparentPort?.close()\n\t\t\tprocess.exit(exitCode)\n\t\t}\n\t}\n}\n\nasync function restart() {\n\ttry {\n\t\t// Notify lifecycle handler\n\t\tawait executeEventHandler(plugins, '_restart', client)\n\t\tclient?.destroy()\n\t\tlogger.debug(`Restarted Robo at ` + new Date().toLocaleString())\n\t} finally {\n\t\tif (isMainThread) {\n\t\t\tprocess.exit(0)\n\t\t} else {\n\t\t\tawait logger.flush()\n\t\t\tparentPort?.postMessage({ event: 'stop', payload: 'exit' })\n\t\t\tparentPort?.close()\n\t\t\tprocess.exit()\n\t\t}\n\t}\n}\n\nfunction getCommandKey(interaction: AutocompleteInteraction | CommandInteraction) {\n\tconst commandKeys = [interaction.commandName]\n\tif (hasProperties<{ getSubcommandGroup: () => string }>(interaction.options, ['getSubcommandGroup'])) {\n\t\ttry {\n\t\t\tcommandKeys.push(interaction.options.getSubcommandGroup())\n\t\t} catch {\n\t\t\t// Ignore\n\t\t}\n\t}\n\tif (hasProperties<{ getSubcommand: () => string }>(interaction.options, ['getSubcommand'])) {\n\t\ttry {\n\t\t\tcommandKeys.push(interaction.options.getSubcommand())\n\t\t} catch {\n\t\t\t// Ignore\n\t\t}\n\t}\n\treturn commandKeys.filter(Boolean).join(' ')\n}\n\nfunction loadPluginData() {\n\tconst config = getConfig()\n\tconst collection = new Collection<string, PluginData>()\n\tif (!config.plugins) {\n\t\treturn collection\n\t}\n\n\tfor (const plugin of config.plugins) {\n\t\tif (typeof plugin === 'string') {\n\t\t\tcollection.set(plugin, { name: plugin })\n\t\t} else if (Array.isArray(plugin)) {\n\t\t\tconst [name, options, metaOptions] = plugin\n\t\t\tcollection.set(name, { name, options, metaOptions })\n\t\t}\n\t}\n\n\treturn collection\n}\n"]}